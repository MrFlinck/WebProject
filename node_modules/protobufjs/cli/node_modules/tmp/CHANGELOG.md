operty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index NCIX_InstancesTable_LastUpdated
			on [System.Activities.DurableInstancing].[InstancesTable] ([LastUpdated])
	')
end
else
begin
	exec('
		create nonclustered index NCIX_InstancesTable_LastUpdated
			on [System.Activities.DurableInstancing].[InstancesTable] ([LastUpdated])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_CreationTime]
			on [System.Activities.DurableInstancing].[InstancesTable] ([CreationTime])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_CreationTime]
			on [System.Activities.DurableInstancing].[InstancesTable] ([CreationTime])
			with (allow_page_locks = off)
	')
end
go


if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_SuspensionExceptionName]
			on [System.Activities.DurableInstancing].[InstancesTable] ([SuspensionExceptionName])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_SuspensionExceptionName]
			on [System.Activities.DurableInstancing].[InstancesTable] ([SuspensionExceptionName])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_ServiceDeploymentId]
			on [System.Activities.DurableInstancing].[InstancesTable] ([ServiceDeploymentId])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_ServiceDeploymentId]
			on [System.Activities.DurableInstancing].[InstancesTable] ([ServiceDeploymentId])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_WorkflowHostType]
			on [System.Activities.DurableInstancing].[InstancesTable] ([WorkflowHostType])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_InstancesTable_WorkflowHostType]
			on [System.Activities.DurableInstancing].[InstancesTable] ([WorkflowHostType])
			with (allow_page_locks = off)
	')
end
go


if exists (select * from sys.objects where object_id = object_id(N'[System.Activities.DurableInstancing].[RunnableInstancesTable]') and type in (N'U'))
	drop table [System.Activities.DurableInstancing].[RunnableInstancesTable]
go

create table [System.Activities.DurableInstancing].[RunnableInstancesTable]
(
	[SurrogateInstanceId] bigint not null,		
	[WorkflowHostType] uniqueidentifier null,
	[ServiceDeploymentId] bigint null,
	[RunnableTime] datetime not null,
	[SurrogateIdentityId] bigint not null
)
go

--SQL Azure doesn't support allow_page_lock option. A conditional compilation is done to remove allow_page_lock in SQL Azure.
if (serverproperty('EngineEdition') = 5)
begin
	alter table [System.Activities.DurableInstancing].[RunnableInstancesTable]
		ADD CONSTRAINT CIX_RunnableInstancesTable_SurrogateInstanceId
			PRIMARY KEY CLUSTERED (SurrogateInstanceId)
			with (ignore_dup_key = on)
end
else
begin
	alter table [System.Activities.DurableInstancing].[RunnableInstancesTable]
		ADD CONSTRAINT CIX_RunnableInstancesTable_SurrogateInstanceId
			PRIMARY KEY CLUSTERED (SurrogateInstanceId)
			with (ignore_dup_key = on, allow_page_locks = off)
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_RunnableInstancesTable]
			on [System.Activities.DurableInstancing].[RunnableInstancesTable] ([WorkflowHostType], [RunnableTime])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_RunnableInstancesTable]
			on [System.Activities.DurableInstancing].[RunnableInstancesTable] ([WorkflowHostType], [RunnableTime])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_RunnableInstancesTable_RunnableTime]
			on [System.Activities.DurableInstancing].[RunnableInstancesTable] ([RunnableTime]) include ([WorkflowHostType], [ServiceDeploymentId])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_RunnableInstancesTable_RunnableTime]
			on [System.Activities.DurableInstancing].[RunnableInstancesTable] ([RunnableTime]) include ([WorkflowHostType], [ServiceDeploymentId])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_RunnableInstancesTable_SurrogateIdentityId]
			on [System.Activities.DurableInstancing].[RunnableInstancesTable] ([SurrogateIdentityId]) 
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_RunnableInstancesTable_SurrogateIdentityId]
			on [System.Activities.DurableInstancing].[RunnableInstancesTable] ([SurrogateIdentityId]) 
			with (allow_page_locks = off)
	')
end
go

if exists (select * from sys.objects where object_id = object_id(N'[System.Activities.DurableInstancing].[KeysTable]') and type in (N'U'))
	drop table [System.Activities.DurableInstancing].[KeysTable]
go

create table [System.Activities.DurableInstancing].[KeysTable]
(
	[Id] uniqueidentifier not null,
	[SurrogateKeyId] bigint identity not null,
	[SurrogateInstanceId] bigint null,
	[EncodingOption] tinyint null,
	[Properties] varbinary(max) null,
	[IsAssociated] bit
) 
go

--SQL Azure doesn't support allow_page_lock option. A conditional compilation is done to remove allow_page_lock in SQL Azure.
if (serverproperty('EngineEdition') = 5)
begin
	alter table [System.Activities.DurableInstancing].[KeysTable]
		ADD CONSTRAINT CIX_KeysTable
		  PRIMARY KEY CLUSTERED (Id)
		  with (ignore_dup_key = on)
end
else
begin
	alter table [System.Activities.DurableInstancing].[KeysTable]
		ADD CONSTRAINT CIX_KeysTable
		  PRIMARY KEY CLUSTERED (Id)
		  with (ignore_dup_key = on, allow_page_locks = off)
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_KeysTable_SurrogateInstanceId]
			on [System.Activities.DurableInstancing].[KeysTable] ([SurrogateInstanceId])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_KeysTable_SurrogateInstanceId]
			on [System.Activities.DurableInstancing].[KeysTable] ([SurrogateInstanceId])
			with (allow_page_locks = off)
	')
end
go

if exists (select * from sys.objects where object_id = object_id(N'[System.Activities.DurableInstancing].[LockOwnersTable]') and type in (N'U'))
	drop table [System.Activities.DurableInstancing].[LockOwnersTable]
go

create table [System.Activities.DurableInstancing].[LockOwnersTable]
(
	[Id] uniqueidentifier not null,
	[SurrogateLockOwnerId] bigint identity not null,
	[LockExpiration] datetime not null,
	[WorkflowHostType] uniqueidentifier null,
	[MachineName] nvarchar(128) not null,
	[EnqueueCommand] bit not null,
	[DeletesInstanceOnCompletion] bit not null,
	[PrimitiveLockOwnerData] varbinary(max) default null,
	[ComplexLockOwnerData] varbinary(max) default null,
	[WriteOnlyPrimitiveLockOwnerData] varbinary(max) default null,
	[WriteOnlyComplexLockOwnerData] varbinary(max) default null,
	[EncodingOption] tinyint default 0,
	[WorkflowIdentityFilter] tinyint not null
)
go

--SQL Azure doesn't support allow_page_lock option. A conditional compilation is done to remove allow_page_lock in SQL Azure.
if (serverproperty('EngineEdition') = 5)
begin
	alter table [System.Activities.DurableInstancing].[LockOwnersTable]
		ADD CONSTRAINT CIX_LockOwnersTable
		  PRIMARY KEY CLUSTERED (SurrogateLockOwnerId)
end
else
begin
	alter table [System.Activities.DurableInstancing].[LockOwnersTable]
		ADD CONSTRAINT CIX_LockOwnersTable
		  PRIMARY KEY CLUSTERED (SurrogateLockOwnerId)
		  with (allow_page_locks = off)
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create unique nonclustered index [NCIX_LockOwnersTable_Id]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([Id])
			with (ignore_dup_key = on)
	')
end
else
begin
	exec('
		create unique nonclustered index [NCIX_LockOwnersTable_Id]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([Id])
			with (ignore_dup_key = on, allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_LockOwnersTable_LockExpiration]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([LockExpiration]) include ([WorkflowHostType], [MachineName])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_LockOwnersTable_LockExpiration]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([LockExpiration]) include ([WorkflowHostType], [MachineName])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_LockOwnersTable_WorkflowHostType]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([WorkflowHostType])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_LockOwnersTable_WorkflowHostType]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([WorkflowHostType])
			with (allow_page_locks = off)
	')
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create nonclustered index [NCIX_LockOwnersTable_WorkflowIdentityFilter]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([WorkflowIdentityFilter])
	')
end
else
begin
	exec('
		create nonclustered index [NCIX_LockOwnersTable_WorkflowIdentityFilter]
			on [System.Activities.DurableInstancing].[LockOwnersTable] ([WorkflowIdentityFilter])
			with (allow_page_locks = off)
	')
end
go

if exists (select * from sys.objects where object_id = object_id(N'[System.Activities.DurableInstancing].[InstanceMetadataChangesTable]') and type in (N'U'))
	drop table [System.Activities.DurableInstancing].[InstanceMetadataChangesTable]
go

create table [System.Activities.DurableInstancing].[InstanceMetadataChangesTable]
(
	[SurrogateInstanceId] bigint not null,
	[ChangeTime] bigint identity not null,
	[EncodingOption] tinyint not null,
	[Change] varbinary(max) not null
)
go

alter table [System.Activities.DurableInstancing].[InstanceMetadataChangesTable]
	ADD CONSTRAINT CIX_InstanceMetadataChangesTable
		PRIMARY KEY CLUSTERED (SurrogateInstanceId, ChangeTime)
go

if exists (select * from sys.objects where object_id = object_id(N'[System.Activities.DurableInstancing].[ServiceDeploymentsTable]') and type in (N'U'))
	drop table [System.Activities.DurableInstancing].[ServiceDeploymentsTable]
go

create table [System.Activities.DurableInstancing].[ServiceDeploymentsTable]
(
	[Id] bigint identity not null,
	[ServiceDeploymentHash] uniqueidentifier not null,
	[SiteName] nvarchar(max) not null,
	[RelativeServicePath] nvarchar(max) not null,
	[RelativeApplicationPath] nvarchar(max) not null,
	[ServiceName] nvarchar(max) not null,
	[ServiceNamespace] nvarchar(max) not null,
)
go

--SQL Azure doesn't support allow_page_lock option. A conditional compilation is done to remove allow_page_lock in SQL Azure.
if (serverproperty('EngineEdition') = 5)
begin
	alter table [System.Activities.DurableInstancing].[ServiceDeploymentsTable]
		ADD CONSTRAINT CIX_ServiceDeploymentsTable
		  PRIMARY KEY CLUSTERED (Id)
end
else
begin
	alter table [System.Activities.DurableInstancing].[ServiceDeploymentsTable]
		ADD CONSTRAINT CIX_ServiceDeploymentsTable
		  PRIMARY KEY CLUSTERED (Id)
		  with (allow_page_locks = off)
end
go

if (serverproperty('EngineEdition') = 5)
begin
	exec('
		create unique nonclustered index [NCIX_ServiceDeploymentsTable_ServiceDeploymentHash]
			on [System.Activities.DurableInstancing].[ServiceDeploymentsTable] ([ServiceDeploymentHash])
			with (ignore_dup_key = on)
	')
end
else
begin
	exec('
		create unique nonclustered index [NCIX_ServiceDeploymentsTable_ServiceDeploymentHash]
			on [System.Activities.DurableInstancing].[ServiceDeploymentsTable] ([ServiceDeploymentHash])
			with (ignore_dup_key = on, allow_page_locks = off)
	')
end
go

if exists (select * from sys.objects where object_id = object_id(N'[System.Activities.DurableInstancing].[InstancePromotedPropertiesTable]') and type in (N'U'))
	drop table [System.Activities.DurableInstancing].[InstancePromotedPropertiesTable]
go

create table [System.Activities.DurableInstancing].[InstancePromotedPropertiesTable]
(
	  [SurrogateInstanceId] bigint not null,
      [PromotionName] nvarchar(400) not null,
      [Value1] sql_variant null,
      [Value2] sql_variant null,
      [Value3] sql_variant null,
      [Value4] sql_variant null,
      [Value5] sql_variant null,
      [Value6] sql_variant null,
      [Value7] sql_variant null,
      [Value8] sql_variant null,
      [Value9] sql_variant null,
      [Value10] sql_variant null,
      [Value11] sql_variant null,
      [Value12] sql_variant null,
      [Value13] sql_variant null,
      [Value14] sql_variant null,
      [Value15] sql_variant null,
      [Value16] sql_variant null,
      [Value17] sql_variant null,
      [Value18] sql_variant null,
      [Value19] sql_variant null,
      [Value20] sql_variant null,
      [Value21] sql_variant null,
      [Value22] sql_variant null,
      [Value23] sql_variant null,
      [Value24] sql_variant null,
      [Value25] sql_variant null,
      [Value26] sql_variant null,
      [Value27] sql_variant null,
      [Value28] sql_variant null,
      [Value29] sql_variant null,
      [Value30] sql_variant null,
      [Value31] sql_variant null,
      [Value32] sql_variant null,
      [Value33] varbinary(max) null,
      [Value34] varbinary(max) null,
      [Value35] varbinary(max) null,
      [Value36] varbinary(max) null,
      [Value37] varbinary(max) null,
      [Value38] varbinary(max) null,
      [Value39] varbinary(max) null,
      [Value40] varbinary(max) null,
      [Value41] varbinary(max) null,
      [Value42] varbinary(max) null,
      [Value43] varbinary(max) null,
      [Value44] varbinary(max) null,
      [Value45] varbinary(max) null,
      [Value46] varbinary(max) null,
      [Value47] varbinary(max) null,
      [Value48] varbinary(max) null,
      [Value49] varbinary(max) null,
      [Value50] varbinary(max) null,
      [Value51] varbinary(max) null,
      [Value52] varbinary(max) null,
      [Value53] varbinary(max) null,
      [Value54] varbinary(max) null,
      [Value55] varbinary(max) null,
      [Value56] varbinary(max) null,
      [Value57] varbinary(max) null,
      [Value58] varbinary(max) null,
      [Value59] varbinary(max) null,
      [Value60] varbinary(max) null,
      [Value61] varbinary(max) null,
      [Value62] varbinary(max) null,
      [Value63] varbinary(max) null,
      [Value64] varbinary(max) null
)
go

--SQL Azure doesn't support allow_page_lock option. A conditional compilation is done to remove allow_page_lock in SQL Azure.
if (serverproperty('EngineEdition') = 5)
begin
	alter table [System.Activities.DurableInstancing].[InstancePromotedPropertiesTable]
		ADD CONSTRAINT CIX_InstancePromotedPropertiesTable
		  PRIMARY KEY CLUSTERED (SurrogateInstanceId, PromotionName)
end
else
begin
	alter table [System.Activities.DurableInstancing].[InstancePromotedPropertiesTable]
		ADD CONSTRAINT CIX_InstancePromotedPropertiesTable
		  PRIMARY KEY CLUSTERED (SurrogateInstanceId, PromotionName)
		  with (allow_page_locks = off)
end
go

if exists (select * from sys.objects where object_id